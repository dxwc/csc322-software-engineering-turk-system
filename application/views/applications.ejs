<!doctype html>
<head>
    <meta charset="UTF-8">
    <title>View Applications</title>
    <script src='axios.min.js'></script>
    <style>
    .application
    {
        border-bottom : 1px solid #ddd;
        padding-bottom: 1em;
        padding-top: 1em;
    }
    .accept
    {
        margin-right: 1em;
    }
    .rejectReason
    {
        width : 100%;
    }
    </style>
</head>
<body>

    <% if(locals.applications) { %>
        <a style='float: right' href='/applications?end_session=true'>Log Out</a>
        <h1>Applications Pending Decision</h1>
        <div id='all_app'>

        <%
            for(let i = 0; i < applications.length; ++i) { %>
            <div class='application'>
                <b>User Name:</b><span class='user_name'>
                    <%= applications[i]._id.user_name %>
                </span><br>
                <b>Role:</b><% if(applications[i]._id.role == true) { %>
                    <span class='role'>Developer</span>
                <% } else { %>
                    <span class='role'>Client</span>
                <% } %><br>
                <b>Amount specified for deposit:</b>
                <span class='deposit_amount'>
                    $<%= applications[i].deposit_amount %>
                </span><br>
                <b>Date Applied:</b>
                <span class='creation_time'>
                    <%= new Date(applications[i]._id.creation_time) %>
                </span><br>
                <span id='<%=applications[i]._id._id%>'>
                    <a class='accept' href>Accept</a>
                    <a class='reject' href>Reject</a>
                    <a
                        class='cancel'
                        style='display : none' href>Cancel</a>
                    <textarea
                        class='rejectReason'
                        style='display: none'
                        placeholder='Your reason for applicaiton rejection...'>
                    </textarea>
                    <a
                        class='save'
                        style='display : none' href>Save</a>
                </span>
            </div>
    <%      } %>
        </div>
    <% } else { %>
        <form actions='/applications' method='post'>
        <input
            type='password'
            placeholder='Access Code'
            name='access_code'><br><br>
        <button
            type='submit'>Enter</button>
        <% if(locals.invalid) { %>
            <br><b style='color: red'>Invalid Access Code, try again</b>
        <% } %>
    </form>
    <% } %>

    <script>

    document.addEventListener('DOMContentLoaded', (event) =>
    {
        let decision =
            document.getElementById('all_app')
            .getElementsByTagName('a');

        let accept = undefined;
        let reject = undefined;
        let decision_sec = undefined; // section
        let application = undefined;

        let accept_link = undefined;
        let reject_link = undefined;
        let save_link = undefined;
        let cancel_link = undefined;
        let rejectReason_link = undefined;

        for(let i = 0; i < decision.length; ++i)
        {
            if(decision[i].className === 'accept')
            {
                decision[i].addEventListener('click', (event) =>
                {
                    event.preventDefault();

                    decision_sec = accept.parentElement;
                    application = decision_sec.parentElement;

                    console.log(decision_sec);

                    application.setAttribute('style', 'opacity: 0.5');
                    decision_sec.setAttribute('style', 'display : none');

                    axios.post
                    (
                        '/decision',
                        {
                            user_id : decision_sec.id,
                            boolean : true
                        }
                    )
                    .then((result) =>
                    {
                        console.log(result);
                    })
                    .catch((err) =>
                    {
                        console.log('Error:\n', err);
                    })
                });
            }
            else if(decision[i].className === 'reject')
            {
                decision[i].addEventListener('click', (event) =>
                {
                    event.preventDefault();

                    reject = decision[i];
                    decision_sec = reject.parentElement;
                    application = decision_sec.parentElement;

                    accept_link = decision_sec.getElementsByClassName('accept')[0];
                    reject_link = decision_sec.getElementsByClassName('reject')[0];
                    cancel_link = decision_sec.getElementsByClassName('cancel')[0];
                    save_link   = decision_sec.getElementsByClassName('save')[0];
                    rejectReason_link
                                = decision_sec
                                  .getElementsByClassName('rejectReason')[0];

                    reject.setAttribute('style', 'display : none');

                    accept_link.setAttribute('style', 'display : none');
                    cancel_link.removeAttribute('style');
                    save_link.removeAttribute('style');
                    rejectReason_link.removeAttribute('style');

                    cancel_link
                    .addEventListener('click', (event) =>
                    {
                        event.preventDefault();

                        cancel_link.setAttribute('style', 'display : none');
                        rejectReason_link.setAttribute('style', 'display : none');
                        save_link.setAttribute('style', 'display : none');
                        accept_link.removeAttribute('style');
                        reject_link.removeAttribute('style');
                    });

                    save_link
                    .addEventListener('click', (event) =>
                    {
                        event.preventDefault();

                        decision_sec.setAttribute('style', 'display: none');
                        application.setAttribute('style', 'opacity: 0.5');

                        axios.post
                        (
                            '/decision',
                            {
                                user_id : decision_sec.id,
                                boolean : false
                            }
                        )
                        .then((result) =>
                        {
                            console.log(result);
                        })
                        .catch((err) =>
                        {
                            console.log('Error:\n', err);
                        })
                    });

                });
            }
        }
    })
    </script>

</body>